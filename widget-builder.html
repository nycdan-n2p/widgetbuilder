<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chat Widget Builder - Admin Panel</title>
    
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            background: #F8FAFC;
            color: #1F2937;
        }
        
        .builder-container {
            display: flex;
            min-height: 100vh;
        }
        
        .sidebar {
            width: 350px;
            background: white;
            border-right: 1px solid #E5E7EB;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0, 0, 0, 0.05);
        }
        
        .preview-area {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .header {
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            margin: 0 0 8px 0;
            color: #1F2937;
        }
        
        .header p {
            color: #6B7280;
            margin: 0;
            font-size: 14px;
        }
        
        .section {
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title::before {
            content: '';
            width: 4px;
            height: 16px;
            background: #4F46E5;
            border-radius: 2px;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 6px;
            color: #374151;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #4F46E5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .color-input {
            width: 100%;
            height: 40px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            cursor: pointer;
            padding: 2px;
        }
        
        .color-input::-webkit-color-swatch {
            border-radius: 4px;
            border: none;
        }
        
        .range-input {
            width: 100%;
            margin: 8px 0;
        }
        
        .range-value {
            display: inline-block;
            background: #F3F4F6;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-input {
            width: 18px;
            height: 18px;
            accent-color: #4F46E5;
        }
        
        .button-group {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
        }
        
        .btn:hover {
            background: #F9FAFB;
        }
        
        .btn.active {
            background: #4F46E5;
            color: white;
            border-color: #4F46E5;
        }
        
        .btn-primary {
            background: #4F46E5;
            color: white;
            border-color: #4F46E5;
        }
        
        .btn-primary:hover {
            background: #4338CA;
        }
        
        .btn-secondary {
            background: #6B7280;
            color: white;
            border-color: #6B7280;
        }
        
        .btn-secondary:hover {
            background: #4B5563;
        }
        
        .btn-success {
            background: #10B981;
            color: white;
            border-color: #10B981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px 20px;
            margin-bottom: 16px;
        }
        
        .domain-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #D1D5DB;
            border-radius: 6px;
            background: #F9FAFB;
        }
        
        .domain-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            border-bottom: 1px solid #E5E7EB;
        }
        
        .domain-item:last-child {
            border-bottom: none;
        }
        
        .domain-info {
            flex: 1;
        }
        
        .domain-name {
            font-weight: 500;
            font-size: 14px;
        }
        
        .domain-token {
            font-size: 12px;
            color: #6B7280;
            font-family: monospace;
        }
        
        .domain-actions {
            display: flex;
            gap: 8px;
        }
        
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        
        .preview-phone {
            width: 300px;
            height: 600px;
            background: white;
            border-radius: 20px;
            margin: 0 auto;
            position: relative;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        .preview-screen {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            position: relative;
        }
        
        .preview-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .code-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #E5E7EB;
        }
        
        .code-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        
        .code-title {
            font-weight: 600;
            color: #374151;
        }
        
        .code-block {
            background: #1F2937;
            color: #F9FAFB;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .copy-btn {
            padding: 6px 12px;
            background: #E5E7EB;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        .copy-btn:hover {
            background: #D1D5DB;
        }
        
        .copy-btn.copied {
            background: #10B981;
            color: white;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        }
        
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #6B7280;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .alert-success {
            background: #ECFDF5;
            color: #065F46;
            border: 1px solid #A7F3D0;
        }
        
        .alert-warning {
            background: #FFFBEB;
            color: #92400E;
            border: 1px solid #FCD34D;
        }
        
        .alert-error {
            background: #FEF2F2;
            color: #991B1B;
            border: 1px solid #FCA5A5;
        }
        
        .widget-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        @media (max-width: 1024px) {
            .builder-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .preview-area {
                min-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="builder-container">
        <!-- Sidebar Controls -->
        <div class="sidebar">
            <div class="header">
                <h1>ü§ñ Widget Builder</h1>
                <p>Customize your AI chat widget and generate secure deployment tokens</p>
            </div>
            
            <!-- AI Agent Configuration -->
            <div class="section">
                <div class="section-title">üîß AI Agent Settings</div>
                
                <div class="form-group">
                    <label class="form-label" for="masterApiToken">Master API Token</label>
                    <input type="password" id="masterApiToken" class="form-input" placeholder="Your Net2Phone AI Agent API token">
                    <small style="color: #6B7280; font-size: 12px;">This token is used to generate secure domain-specific tokens</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="apiUrl">API URL</label>
                    <input type="url" id="apiUrl" class="form-input" value="https://aiagent.net2phone.com" placeholder="Your AI Agent API URL">
                </div>
                
                <button class="btn btn-icon btn-primary" id="manageDomains">
                    <span>üåê</span>
                    Manage Domains & Tokens
                </button>
            </div>
            
            <!-- Widget Appearance -->
            <div class="section">
                <div class="section-title">üé® Appearance</div>
                
                <div class="form-group">
                    <label class="form-label" for="primaryColor">Primary Color</label>
                    <input type="color" id="primaryColor" class="color-input" value="#4F46E5">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="secondaryColor">Background Color</label>
                    <input type="color" id="secondaryColor" class="color-input" value="#F3F4F6">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="textColor">Text Color</label>
                    <input type="color" id="textColor" class="color-input" value="#1F2937">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Position</label>
                    <div class="button-group">
                        <button class="btn position-btn active" data-position="bottom-right">Bottom Right</button>
                        <button class="btn position-btn" data-position="bottom-left">Bottom Left</button>
                    </div>
                    <div class="button-group">
                        <button class="btn position-btn" data-position="top-right">Top Right</button>
                        <button class="btn position-btn" data-position="top-left">Top Left</button>
                    </div>
                </div>
            </div>
            
            <!-- Widget Content -->
            <div class="section">
                <div class="section-title">üí¨ Content</div>
                
                <div class="form-group">
                    <label class="form-label" for="widgetTitle">Widget Title</label>
                    <input type="text" id="widgetTitle" class="form-input" value="AI Assistant" placeholder="Widget header title">
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="greeting">Greeting Message</label>
                    <textarea id="greeting" class="form-textarea" placeholder="Hi! How can I help you today?">Hi! How can I help you today?</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="placeholder">Input Placeholder</label>
                    <input type="text" id="placeholder" class="form-input" value="Type your message..." placeholder="Input field placeholder">
                </div>
            </div>
            
            <!-- Widget Size -->
            <div class="section">
                <div class="section-title">üìè Size & Dimensions</div>
                
                <div class="form-group">
                    <label class="form-label">
                        Widget Width: <span class="range-value" id="widthValue">350px</span>
                    </label>
                    <input type="range" id="widgetWidth" class="range-input" min="300" max="500" value="350">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Widget Height: <span class="range-value" id="heightValue">500px</span>
                    </label>
                    <input type="range" id="widgetHeight" class="range-input" min="400" max="700" value="500">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Icon Size: <span class="range-value" id="iconSizeValue">56px</span>
                    </label>
                    <input type="range" id="iconSize" class="range-input" min="40" max="80" value="56">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Border Radius: <span class="range-value" id="radiusValue">16px</span>
                    </label>
                    <input type="range" id="borderRadius" class="range-input" min="0" max="30" value="16">
                </div>
            </div>
            
            <!-- Spam Protection -->
            <div class="section">
                <div class="section-title">üõ°Ô∏è Spam Protection</div>
                
                <div class="form-group">
                    <label class="form-label">
                        Messages Per Minute: <span class="range-value" id="perMinuteValue">10</span>
                    </label>
                    <input type="range" id="maxPerMinute" class="range-input" min="1" max="60" value="10">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Messages Per Hour: <span class="range-value" id="perHourValue">50</span>
                    </label>
                    <input type="range" id="maxPerHour" class="range-input" min="5" max="200" value="50">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        Max Message Length: <span class="range-value" id="maxLengthValue">2000</span>
                    </label>
                    <input type="range" id="maxMessageLength" class="range-input" min="100" max="5000" value="2000">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="blockSuspicious" class="checkbox-input" checked>
                        <label class="form-label" for="blockSuspicious">Block Suspicious Content</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="showBadge" class="checkbox-input" checked>
                        <label class="form-label" for="showBadge">Show Notification Badge</label>
                    </div>
                </div>
            </div>
            
            <!-- Generate Code -->
            <div class="section">
                <button class="btn btn-icon btn-success" id="generateCode">
                    <span>‚ö°</span>
                    Generate Widget Code
                </button>
            </div>
        </div>
        
        <!-- Preview Area -->
        <div class="preview-area">
            <div class="preview-phone">
                <div class="preview-screen">
                    <div class="preview-content">
                        <h3>Website Preview</h3>
                        <p>This is how your widget will appear on your website.</p>
                        <p>Click the floating chat icon to test the widget!</p>
                    </div>
                </div>
            </div>
            
            <!-- Widget Preview (will be injected) -->
            <div id="widgetPreview" class="widget-preview"></div>
            
            <!-- Generated Code Section -->
            <div class="code-section" id="codeSection" style="display: none;">
                <div class="code-header">
                    <div class="code-title">Generated Widget Code</div>
                    <button class="copy-btn" id="copyCode">Copy Code</button>
                </div>
                <div class="code-block" id="generatedCode"></div>
                
                <div style="margin-top: 20px;">
                    <h4 style="margin-bottom: 12px;">Deployment Instructions:</h4>
                    <ol style="padding-left: 20px; color: #6B7280; font-size: 14px;">
                        <li>Copy the generated code above</li>
                        <li>Paste it into your website's HTML, just before the closing &lt;/body&gt; tag</li>
                        <li>Upload the <code>widget.js</code> file to your web server</li>
                        <li>Test the widget on your website</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Domain Management Modal -->
    <div class="modal" id="domainModal">
        <div class="modal-content">
            <button class="modal-close" id="closeDomainModal">&times;</button>
            
            <div class="modal-header">
                <h2 class="modal-title">üåê Domain & Token Management</h2>
            </div>
            
            <div id="domainAlerts"></div>
            
            <div class="form-group">
                <label class="form-label" for="newDomain">Add New Domain</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="newDomain" class="form-input" placeholder="example.com" style="flex: 1;">
                    <button class="btn btn-primary" id="addDomain">Add Domain</button>
                </div>
                <small style="color: #6B7280; font-size: 12px;">
                    Enter domain without protocol (e.g., "yoursite.com" not "https://yoursite.com")
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Configured Domains</label>
                <div class="domain-list" id="domainList">
                    <div style="padding: 20px; text-align: center; color: #6B7280;">
                        No domains configured yet. Add a domain to generate secure tokens.
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px; padding: 16px; background: #F0F9FF; border-radius: 8px; border: 1px solid #0EA5E9;">
                <h4 style="margin: 0 0 8px 0; color: #0C4A6E;">üîí Security Benefits</h4>
                <ul style="margin: 0; padding-left: 20px; color: #075985; font-size: 14px;">
                    <li>Each domain gets a unique, restricted token</li>
                    <li>Tokens only work on their assigned domain</li>
                    <li>Easy to revoke access for specific domains</li>
                    <li>Master API token stays secure on your server</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Widget Builder Logic
        class WidgetBuilder {
            constructor() {
                this.config = {
                    // AI Agent Settings
                    masterApiToken: '',
                    apiUrl: 'https://aiagent.net2phone.com',
                    
                    // Appearance
                    primaryColor: '#4F46E5',
                    secondaryColor: '#F3F4F6',
                    textColor: '#1F2937',
                    position: 'bottom-right',
                    
                    // Content
                    title: 'AI Assistant',
                    greeting: 'Hi! How can I help you today?',
                    placeholder: 'Type your message...',
                    
                    // Size
                    width: '350px',
                    height: '500px',
                    iconSize: '56px',
                    borderRadius: '16px',
                    
                    // Protection
                    maxMessagesPerMinute: 10,
                    maxMessagesPerHour: 50,
                    maxMessageLength: 2000,
                    minMessageInterval: 2000,
                    blockSuspiciousContent: true,
                    showUnreadBadge: true,
                    
                    // Domains
                    domains: []
                };
                
                this.initializeEvents();
                this.updatePreview();
                this.loadSavedConfig();
            }
            
            initializeEvents() {
                // Color inputs
                document.getElementById('primaryColor').addEventListener('input', (e) => {
                    this.config.primaryColor = e.target.value;
                    this.updatePreview();
                });
                
                document.getElementById('secondaryColor').addEventListener('input', (e) => {
                    this.config.secondaryColor = e.target.value;
                    this.updatePreview();
                });
                
                document.getElementById('textColor').addEventListener('input', (e) => {
                    this.config.textColor = e.target.value;
                    this.updatePreview();
                });
                
                // Position buttons
                document.querySelectorAll('.position-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.position-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.config.position = e.target.dataset.position;
                        this.updatePreview();
                    });
                });
                
                // Text inputs
                document.getElementById('widgetTitle').addEventListener('input', (e) => {
                    this.config.title = e.target.value;
                    this.updatePreview();
                });
                
                document.getElementById('greeting').addEventListener('input', (e) => {
                    this.config.greeting = e.target.value;
                    this.updatePreview();
                });
                
                document.getElementById('placeholder').addEventListener('input', (e) => {
                    this.config.placeholder = e.target.value;
                    this.updatePreview();
                });
                
                // Range inputs
                this.setupRangeInput('widgetWidth', 'widthValue', 'width', 'px');
                this.setupRangeInput('widgetHeight', 'heightValue', 'height', 'px');
                this.setupRangeInput('iconSize', 'iconSizeValue', 'iconSize', 'px');
                this.setupRangeInput('borderRadius', 'radiusValue', 'borderRadius', 'px');
                this.setupRangeInput('maxPerMinute', 'perMinuteValue', 'maxMessagesPerMinute');
                this.setupRangeInput('maxPerHour', 'perHourValue', 'maxMessagesPerHour');
                this.setupRangeInput('maxMessageLength', 'maxLengthValue', 'maxMessageLength');
                
                // Checkboxes
                document.getElementById('blockSuspicious').addEventListener('change', (e) => {
                    this.config.blockSuspiciousContent = e.target.checked;
                });
                
                document.getElementById('showBadge').addEventListener('change', (e) => {
                    this.config.showUnreadBadge = e.target.checked;
                    this.updatePreview();
                });
                
                // Modal events
                document.getElementById('manageDomains').addEventListener('click', () => {
                    this.showDomainModal();
                });
                
                document.getElementById('closeDomainModal').addEventListener('click', () => {
                    this.hideDomainModal();
                });
                
                document.getElementById('addDomain').addEventListener('click', () => {
                    this.addDomain();
                });
                
                // Generate code
                document.getElementById('generateCode').addEventListener('click', () => {
                    this.generateCode();
                });
                
                // Copy code
                document.getElementById('copyCode').addEventListener('click', () => {
                    this.copyCode();
                });
                
                // Save config on changes
                document.getElementById('masterApiToken').addEventListener('input', (e) => {
                    this.config.masterApiToken = e.target.value;
                    this.saveConfig();
                });
                
                document.getElementById('apiUrl').addEventListener('input', (e) => {
                    this.config.apiUrl = e.target.value;
                    this.saveConfig();
                });
            }
            
            setupRangeInput(inputId, valueId, configKey, suffix = '') {
                const input = document.getElementById(inputId);
                const valueDisplay = document.getElementById(valueId);
                
                input.addEventListener('input', (e) => {
                    const value = e.target.value;
                    this.config[configKey] = suffix ? value + suffix : parseInt(value);
                    valueDisplay.textContent = suffix ? value + suffix : value;
                    this.updatePreview();
                });
            }
            
            updatePreview() {
                const preview = document.getElementById('widgetPreview');
                
                // Generate widget HTML using string concatenation
                let widgetHTML = '<div id="aiWidget" style="';
                widgetHTML += '--primary-color: ' + this.config.primaryColor + ';';
                widgetHTML += '--secondary-color: ' + this.config.secondaryColor + ';';
                widgetHTML += '--text-color: ' + this.config.textColor + ';';
                widgetHTML += '--border-radius: ' + this.config.borderRadius + ';';
                widgetHTML += '--widget-width: ' + this.config.width + ';';
                widgetHTML += '--widget-height: ' + this.config.height + ';';
                widgetHTML += '--icon-size: ' + this.config.iconSize + ';';
                widgetHTML += '">';
                
                // Button
                widgetHTML += '<button id="aiWidgetButton" class="ai-widget-button ' + this.config.position + '" style="';
                widgetHTML += 'position: fixed; z-index: 10000; background: ' + this.config.primaryColor + ';';
                widgetHTML += 'border: none; border-radius: 50%; cursor: pointer;';
                widgetHTML += 'transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);';
                widgetHTML += 'box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);';
                widgetHTML += 'display: flex; align-items: center; justify-content: center;';
                widgetHTML += 'width: ' + this.config.iconSize + '; height: ' + this.config.iconSize + ';';
                widgetHTML += this.getPositionStyles(this.config.position);
                widgetHTML += '">';
                
                // Icon
                widgetHTML += '<svg class="ai-widget-icon" viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: white; transition: transform 0.3s ease;">';
                widgetHTML += '<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>';
                widgetHTML += '</svg>';
                
                // Badge (conditional)
                if (this.config.showUnreadBadge) {
                    widgetHTML += '<div id="aiWidgetBadge" style="position: absolute; top: -2px; right: -2px;';
                    widgetHTML += 'background: #EF4444; color: white; border-radius: 50%; width: 18px; height: 18px;';
                    widgetHTML += 'font-size: 10px; font-weight: bold; display: flex; align-items: center;';
                    widgetHTML += 'justify-content: center; transform: scale(1); transition: transform 0.2s ease;">1</div>';
                }
                
                widgetHTML += '</button>';
                
                // Container
                widgetHTML += '<div id="aiWidgetContainer" class="ai-widget-container ' + this.config.position + '" style="';
                widgetHTML += 'position: fixed; z-index: 9999; background: white;';
                widgetHTML += 'border-radius: ' + this.config.borderRadius + ';';
                widgetHTML += 'box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15); overflow: hidden;';
                widgetHTML += 'transform: scale(0.8) translateY(20px); opacity: 0;';
                widgetHTML += 'transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);';
                widgetHTML += 'width: ' + this.config.width + '; height: ' + this.config.height + ';';
                widgetHTML += 'display: flex; flex-direction: column;';
                widgetHTML += this.getContainerPositionStyles(this.config.position);
                widgetHTML += '">';
                
                // Header
                widgetHTML += '<div class="ai-widget-header" style="background: ' + this.config.primaryColor + ';';
                widgetHTML += 'color: white; padding: 16px 20px; display: flex; align-items: center; justify-content: space-between;">';
                widgetHTML += '<div class="ai-widget-title" style="font-weight: 600; font-size: 16px;">' + this.config.title + '</div>';
                widgetHTML += '<button class="ai-widget-close" style="background: none; border: none; color: white; cursor: pointer; padding: 4px; border-radius: 4px; transition: background 0.2s ease;">';
                widgetHTML += '<svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">';
                widgetHTML += '<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>';
                widgetHTML += '</svg></button></div>';
                
                // Messages
                widgetHTML += '<div class="ai-widget-messages" style="flex: 1; padding: 20px; overflow-y: auto; background: ' + this.config.secondaryColor + ';">';
                widgetHTML += '<div class="ai-message" style="margin-bottom: 12px; max-width: 85%; word-wrap: break-word;">';
                widgetHTML += '<div class="message-bubble" style="padding: 12px 16px; border-radius: 18px; font-size: 14px; line-height: 1.4;';
                widgetHTML += 'background: white; color: ' + this.config.textColor + '; border-bottom-left-radius: 4px;">';
                widgetHTML += this.config.greeting + '</div></div></div>';
                
                // Input
                widgetHTML += '<div class="ai-widget-input" style="padding: 16px 20px; background: white; border-top: 1px solid #E5E7EB; display: flex; gap: 12px; align-items: flex-end;">';
                widgetHTML += '<textarea placeholder="' + this.config.placeholder + '" style="flex: 1; border: 1px solid #D1D5DB; border-radius: 20px;';
                widgetHTML += 'padding: 10px 16px; font-size: 14px; outline: none; transition: border-color 0.2s ease;';
                widgetHTML += 'resize: none; min-height: 20px; max-height: 80px; font-family: inherit;"></textarea>';
                widgetHTML += '<button style="background: ' + this.config.primaryColor + '; border: none; border-radius: 50%;';
                widgetHTML += 'width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;';
                widgetHTML += 'cursor: pointer; transition: all 0.2s ease;">';
                widgetHTML += '<svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: white;">';
                widgetHTML += '<path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" /></svg></button>';
                widgetHTML += '</div></div></div>';
                
                preview.innerHTML = widgetHTML;
                
                // Add click handler for demo
                const button = preview.querySelector('#aiWidgetButton');
                const container = preview.querySelector('#aiWidgetContainer');
                
                if (button && container) {
                    button.addEventListener('click', () => {
                        const isOpen = container.style.transform === 'scale(1) translateY(0px)';
                        if (isOpen) {
                            container.style.transform = 'scale(0.8) translateY(20px)';
                            container.style.opacity = '0';
                            button.querySelector('.ai-widget-icon').style.transform = 'rotate(0deg)';
                        } else {
                            container.style.transform = 'scale(1) translateY(0px)';
                            container.style.opacity = '1';
                            button.querySelector('.ai-widget-icon').style.transform = 'rotate(45deg)';
                        }
                    });
                }
                
                this.saveConfig();
            }
            
            getPositionStyles(position) {
                switch (position) {
                    case 'bottom-right': return 'bottom: 20px; right: 20px;';
                    case 'bottom-left': return 'bottom: 20px; left: 20px;';
                    case 'top-right': return 'top: 20px; right: 20px;';
                    case 'top-left': return 'top: 20px; left: 20px;';
                    default: return 'bottom: 20px; right: 20px;';
                }
            }
            
            getContainerPositionStyles(position) {
                switch (position) {
                    case 'bottom-right': return 'bottom: 90px; right: 20px;';
                    case 'bottom-left': return 'bottom: 90px; left: 20px;';
                    case 'top-right': return 'top: 90px; right: 20px;';
                    case 'top-left': return 'top: 90px; left: 20px;';
                    default: return 'bottom: 90px; right: 20px;';
                }
            }
            
            showDomainModal() {
                document.getElementById('domainModal').classList.add('show');
                this.updateDomainList();
            }
            
            hideDomainModal() {
                document.getElementById('domainModal').classList.remove('show');
            }
            
            addDomain() {
                const domainInput = document.getElementById('newDomain');
                const domain = domainInput.value.trim().toLowerCase();
                
                if (!domain) {
                    this.showAlert('Please enter a domain name.', 'error');
                    return;
                }
                
                // Basic domain validation
                const domainRegex = /^[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?(?:\.[a-zA-Z0-9][a-zA-Z0-9-]{0,61}[a-zA-Z0-9]?)*$/;
                if (!domainRegex.test(domain)) {
                    this.showAlert('Please enter a valid domain name.', 'error');
                    return;
                }
                
                // Check if domain already exists
                if (this.config.domains.find(d => d.domain === domain)) {
                    this.showAlert('Domain already exists.', 'warning');
                    return;
                }
                
                // Generate secure token for this domain
                const token = this.generateDomainToken(domain);
                
                this.config.domains.push({
                    domain: domain,
                    token: token,
                    created: new Date().toISOString(),
                    enabled: true
                });
                
                domainInput.value = '';
                this.updateDomainList();
                this.saveConfig();
                this.showAlert('Domain "' + domain + '" added successfully with secure token.', 'success');
            }
            
            generateDomainToken(domain) {
                // In a real implementation, this would call your backend API
                // to generate a secure domain-specific token
                const prefix = 'dwt_'; // domain widget token
                const timestamp = Date.now().toString(36);
                const random = Math.random().toString(36).substring(2);
                const domainHash = btoa(domain).substring(0, 8);
                
                return prefix + timestamp + '_' + domainHash + '_' + random;
            }
            
            updateDomainList() {
                const listContainer = document.getElementById('domainList');
                
                if (this.config.domains.length === 0) {
                    listContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #6B7280;">' +
                        'No domains configured yet. Add a domain to generate secure tokens.' +
                        '</div>';
                    return;
                }
                
                listContainer.innerHTML = this.config.domains.map(domain => {
                    return '<div class="domain-item">' +
                        '<div class="domain-info">' +
                        '<div class="domain-name">' + domain.domain + '</div>' +
                        '<div class="domain-token">' + domain.token + '</div>' +
                        '</div>' +
                        '<div class="domain-actions">' +
                        '<button class="btn btn-small copy-token-btn" data-token="' + domain.token + '">Copy</button>' +
                        '<button class="btn btn-small" onclick="widgetBuilder.removeDomain(\'' + domain.domain + '\')" style="background: #EF4444; color: white; border-color: #EF4444;">Remove</button>' +
                        '</div>' +
                        '</div>';
                }).join('');
                
                // Add copy token functionality
                listContainer.querySelectorAll('.copy-token-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const token = e.target.dataset.token;
                        navigator.clipboard.writeText(token).then(() => {
                            e.target.textContent = 'Copied!';
                            e.target.style.background = '#10B981';
                            e.target.style.color = 'white';
                            setTimeout(() => {
                                e.target.textContent = 'Copy';
                                e.target.style.background = '';
                                e.target.style.color = '';
                            }, 2000);
                        });
                    });
                });
            }
            
            removeDomain(domain) {
                if (confirm('Are you sure you want to remove "' + domain + '"? This will invalidate its token.')) {
                    this.config.domains = this.config.domains.filter(d => d.domain !== domain);
                    this.updateDomainList();
                    this.saveConfig();
                    this.showAlert('Domain "' + domain + '" removed successfully.', 'success');
                }
            }
            
            showAlert(message, type) {
                const alertsContainer = document.getElementById('domainAlerts');
                const alertId = 'alert_' + Date.now();
                
                const alert = document.createElement('div');
                alert.id = alertId;
                alert.className = 'alert alert-' + type;
                alert.textContent = message;
                
                alertsContainer.appendChild(alert);
                
                setTimeout(() => {
                    const element = document.getElementById(alertId);
                    if (element) {
                        element.remove();
                    }
                }, 5000);
            }
            
            generateCode() {
                if (this.config.domains.length === 0) {
                    alert('Please add at least one domain first. This ensures secure token generation.');
                    this.showDomainModal();
                    return;
                }
                
                const code = this.createWidgetCode();
                console.log('Generated code:', code); // Debug output
                const codeElement = document.getElementById('generatedCode');
                // Clear any existing content first
                codeElement.innerHTML = '';
                // Set as plain text to avoid any JavaScript execution
                codeElement.textContent = code;
                document.getElementById('codeSection').style.display = 'block';
                document.getElementById('codeSection').scrollIntoView({ behavior: 'smooth' });
            }
            
            createWidgetCode() {
                // Build domain configuration
                const domainConfigs = this.config.domains.map(domain => {
                    return [
                        '        // Configuration for ' + domain.domain,
                        '        if (window.location.hostname === \'' + domain.domain + '\' || window.location.hostname.endsWith(\'.' + domain.domain + '\')) {',
                        '            widgetToken = \'' + domain.token + '\';',
                        '        }'
                    ].join('\n');
                }).join('\n');
                
                const allowedDomains = this.config.domains.map(d => '\'' + d.domain + '\'').join(', ');
                
                // Create the complete code as a single clean string
                const codeLines = [
                    '<!-- AI Chat Widget - Generated by Widget Builder -->',
                    '<script>',
                    '    (function() {',
                    '        // Secure domain-based token selection',
                    '        let widgetToken = \'\';',
                    domainConfigs,
                    '',
                    '        if (!widgetToken) {',
                    '            console.warn(\'AI Chat Widget: No token configured for domain:\', window.location.hostname);',
                    '            return; // Don\'t load widget on unauthorized domains',
                    '        }',
                    '',
                    '        // Widget Configuration',
                    '        window.aiWidgetConfig = {',
                    '            // AI Agent Settings (secure domain token)',
                    '            apiToken: widgetToken,',
                    '            apiUrl: \'' + this.config.apiUrl + '\',',
                    '            enabled: true,',
                    '',
                    '            // Spam Protection Settings',
                    '            maxMessagesPerMinute: ' + this.config.maxMessagesPerMinute + ',',
                    '            maxMessagesPerHour: ' + this.config.maxMessagesPerHour + ',',
                    '            maxMessageLength: ' + this.config.maxMessageLength + ',',
                    '            minMessageInterval: ' + this.config.minMessageInterval + ',',
                    '            allowedDomains: [' + allowedDomains + '],',
                    '            blockSuspiciousContent: ' + this.config.blockSuspiciousContent + ',',
                    '',
                    '            // Widget Appearance',
                    '            primaryColor: \'' + this.config.primaryColor + '\',',
                    '            secondaryColor: \'' + this.config.secondaryColor + '\',',
                    '            textColor: \'' + this.config.textColor + '\',',
                    '            position: \'' + this.config.position + '\',',
                    '',
                    '            // Widget Content',
                    '            greeting: \'' + this.config.greeting.replace(/'/g, "\\'") + '\',',
                    '            placeholder: \'' + this.config.placeholder.replace(/'/g, "\\'") + '\',',
                    '            title: \'' + this.config.title.replace(/'/g, "\\'") + '\',',
                    '',
                    '            // Size & Styling',
                    '            borderRadius: \'' + this.config.borderRadius + '\',',
                    '            width: \'' + this.config.width + '\',',
                    '            height: \'' + this.config.height + '\',',
                    '            iconSize: \'' + this.config.iconSize + '\',',
                    '            showUnreadBadge: ' + this.config.showUnreadBadge + ',',
                    '        };',
                    '',
                    '        // Load the widget script',
                    '        const script = document.createElement(\'script\');',
                    '        script.src = \'/widget.js\'; // Update this path as needed',
                    '        script.onload = function() {',
                    '            console.log(\'AI Chat Widget loaded successfully for domain:\', window.location.hostname);',
                    '        };',
                    '        script.onerror = function() {',
                    '            console.error(\'Failed to load AI Chat Widget script\');',
                    '        };',
                    '        document.head.appendChild(script);',
                    '    })();',
                    '</script>',
                    '',
                    '<!-- Widget HTML Structure -->',
                    '<div id="aiWidget">',
                    '    <!-- Floating Button -->',
                    '    <button id="aiWidgetButton" class="ai-widget-button">',
                    '        <svg class="ai-widget-icon" viewBox="0 0 24 24">',
                    '            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>',
                    '        </svg>',
                    this.config.showUnreadBadge ? '        <div id="aiWidgetBadge" class="ai-widget-badge">1</div>' : '',
                    '    </button>',
                    '',
                    '    <!-- Chat Container -->',
                    '    <div id="aiWidgetContainer" class="ai-widget-container">',
                    '        <div class="ai-widget-header">',
                    '            <div class="ai-widget-title" id="aiWidgetTitle">' + this.config.title.replace(/'/g, "\\'") + '</div>',
                    '            <button id="aiWidgetClose" class="ai-widget-close">',
                    '                <svg viewBox="0 0 24 24" fill="currentColor">',
                    '                    <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>',
                    '                </svg>',
                    '            </button>',
                    '        </div>',
                    '',
                    '        <div id="aiWidgetMessages" class="ai-widget-messages">',
                    '            <div class="ai-message">',
                    '                <div class="message-bubble" id="aiGreeting">' + this.config.greeting.replace(/'/g, "\\'") + '</div>',
                    '            </div>',
                    '        </div>',
                    '',
                    '        <div class="ai-widget-input">',
                    '            <textarea id="aiInputField" class="ai-input-field" placeholder="' + this.config.placeholder.replace(/'/g, "\\'") + '" rows="1"></textarea>',
                    '            <button id="aiSendButton" class="ai-send-button">',
                    '                <svg viewBox="0 0 24 24">',
                    '                    <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z" />',
                    '                </svg>',
                    '            </button>',
                    '        </div>',
                    '    </div>',
                    '</div>',
                    '',
                    '<style>',
                    ':root {',
                    '    --primary-color: ' + this.config.primaryColor + ';',
                    '    --secondary-color: ' + this.config.secondaryColor + ';',
                    '    --text-color: ' + this.config.textColor + ';',
                    '    --border-radius: ' + this.config.borderRadius + ';',
                    '    --widget-width: ' + this.config.width + ';',
                    '    --widget-height: ' + this.config.height + ';',
                    '    --icon-size: ' + this.config.iconSize + ';',
                    '}',
                    '',
                    '.ai-widget-button {',
                    '    position: fixed;',
                    '    z-index: 10000;',
                    '    background: var(--primary-color);',
                    '    border: none;',
                    '    border-radius: 50%;',
                    '    cursor: pointer;',
                    '    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);',
                    '    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);',
                    '    display: flex;',
                    '    align-items: center;',
                    '    justify-content: center;',
                    '    width: var(--icon-size);',
                    '    height: var(--icon-size);',
                    '    ' + this.getPositionStyles(this.config.position),
                    '}',
                    '',
                    '.ai-widget-button:hover {',
                    '    transform: scale(1.1);',
                    '    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);',
                    '}',
                    '',
                    '.ai-widget-icon {',
                    '    width: 24px;',
                    '    height: 24px;',
                    '    fill: white;',
                    '    transition: transform 0.3s ease;',
                    '}',
                    '',
                    '.ai-widget-button.open .ai-widget-icon {',
                    '    transform: rotate(45deg);',
                    '}'
                ];
                
                // Add badge CSS if enabled
                if (this.config.showUnreadBadge) {
                    codeLines.push(
                        '',
                        '.ai-widget-badge {',
                        '    position: absolute;',
                        '    top: -2px;',
                        '    right: -2px;',
                        '    background: #EF4444;',
                        '    color: white;',
                        '    border-radius: 50%;',
                        '    width: 18px;',
                        '    height: 18px;',
                        '    font-size: 10px;',
                        '    font-weight: bold;',
                        '    display: flex;',
                        '    align-items: center;',
                        '    justify-content: center;',
                        '    transform: scale(0);',
                        '    transition: transform 0.2s ease;',
                        '}',
                        '',
                        '.ai-widget-badge.show {',
                        '    transform: scale(1);',
                        '}'
                    );
                }
                
                // Add remaining CSS
                codeLines.push(
                    '',
                    '.ai-widget-container {',
                    '    position: fixed;',
                    '    z-index: 9999;',
                    '    background: white;',
                    '    border-radius: var(--border-radius);',
                    '    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);',
                    '    overflow: hidden;',
                    '    transform: scale(0.8) translateY(20px);',
                    '    opacity: 0;',
                    '    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);',
                    '    width: var(--widget-width);',
                    '    height: var(--widget-height);',
                    '    display: flex;',
                    '    flex-direction: column;',
                    '    ' + this.getContainerPositionStyles(this.config.position),
                    '}',
                    '',
                    '.ai-widget-container.open {',
                    '    transform: scale(1) translateY(0);',
                    '    opacity: 1;',
                    '}',
                    '',
                    '/* Add remaining widget styles from your main CSS file */',
                    '</style>'
                );
                
                return codeLines.filter(line => line !== '').join('\n');
            }
            
            copyCode() {
                const code = document.getElementById('generatedCode').textContent;
                navigator.clipboard.writeText(code).then(() => {
                    const btn = document.getElementById('copyCode');
                    btn.textContent = 'Copied!';
                    btn.classList.add('copied');
                    setTimeout(() => {
                        btn.textContent = 'Copy Code';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            }
            
            saveConfig() {
                localStorage.setItem('widgetBuilderConfig', JSON.stringify(this.config));
            }
            
            loadSavedConfig() {
                const saved = localStorage.getItem('widgetBuilderConfig');
                if (saved) {
                    const savedConfig = JSON.parse(saved);
                    this.config = { ...this.config, ...savedConfig };
                    this.loadConfigIntoForm();
                }
            }
            
            loadConfigIntoForm() {
                // Load values into form fields
                document.getElementById('masterApiToken').value = this.config.masterApiToken || '';
                document.getElementById('apiUrl').value = this.config.apiUrl;
                document.getElementById('primaryColor').value = this.config.primaryColor;
                document.getElementById('secondaryColor').value = this.config.secondaryColor;
                document.getElementById('textColor').value = this.config.textColor;
                document.getElementById('widgetTitle').value = this.config.title;
                document.getElementById('greeting').value = this.config.greeting;
                document.getElementById('placeholder').value = this.config.placeholder;
                
                // Set range values
                const widthValue = parseInt(this.config.width);
                document.getElementById('widgetWidth').value = widthValue;
                document.getElementById('widthValue').textContent = widthValue + 'px';
                
                const heightValue = parseInt(this.config.height);
                document.getElementById('widgetHeight').value = heightValue;
                document.getElementById('heightValue').textContent = heightValue + 'px';
                
                const iconSizeValue = parseInt(this.config.iconSize);
                document.getElementById('iconSize').value = iconSizeValue;
                document.getElementById('iconSizeValue').textContent = iconSizeValue + 'px';
                
                const radiusValue = parseInt(this.config.borderRadius);
                document.getElementById('borderRadius').value = radiusValue;
                document.getElementById('radiusValue').textContent = radiusValue + 'px';
                
                document.getElementById('maxPerMinute').value = this.config.maxMessagesPerMinute;
                document.getElementById('perMinuteValue').textContent = this.config.maxMessagesPerMinute;
                
                document.getElementById('maxPerHour').value = this.config.maxMessagesPerHour;
                document.getElementById('perHourValue').textContent = this.config.maxMessagesPerHour;
                
                document.getElementById('maxMessageLength').value = this.config.maxMessageLength;
                document.getElementById('maxLengthValue').textContent = this.config.maxMessageLength;
                
                // Set checkboxes
                document.getElementById('blockSuspicious').checked = this.config.blockSuspiciousContent;
                document.getElementById('showBadge').checked = this.config.showUnreadBadge;
                
                // Set position
                document.querySelectorAll('.position-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.position === this.config.position);
                });
            }
        }
        
        // Initialize the widget builder
        const widgetBuilder = new WidgetBuilder();
        
        // Make it globally accessible for domain management
        window.widgetBuilder = widgetBuilder;
    </script>
</body>
</html>